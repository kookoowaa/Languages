# Dax (Power BI)

> - DAX<sup>Data Analysis Expression</sup>는 Excel, Power Pivot, Power BI, SQL Management Studio 등에서 사용되는 언어입니다.
> - 범용성/확장성이이 다소 떨어지는 언어이지만, Microsoft 에서 활용된다는 점이 장점으로 나타나기도 합니다.

## 1. Dax의 수식

```dax
측정값 =  Calculate(
			sum( '테이블명'[변수명]),
				filter(allselected('테이블명'))
			)
```

- 수식의 결과 값은 **<u>측정값, 열 추가</u>**, 또는 **<u>새 테이블</u>** 형태로 반환될 수 있습니다.
- 인수는 일반적으로 **테이블**과 **변수(열)**이며, 이를 호출할 때에는 따옴표(테이블), 대괄호(변수)를 사용합니다.
- 일반적으로 "열 추가" 보다는 컨텍스트에 따라 값이 변경되는 "측정값"을 사용하는 것을 권장하며, 이 때 데이터 모델 상에서는 결과 값을 확인 하기 어렵다는 단점은 있습니다.
- 위의 `CALCULATE()` 함수가 가장 일반적으로 사용되는 함수 중 하나로, 첫번째 인자로 테이블(컬럼)을, 두번쨰 인자로 필터 조건을 내려 받아서 계산 값을 반환합니다.

## 2. Evaluation concept

- DAX에서 수식을 평가하는 context는 **filter context**와 **row context** 두가지가 있습니다.
- Filter context는 계산식이 열, 또는 행 매트릭스에 따라 다른 값을 반환하게 되는 것을 의미합니다.
  예를 들어 `Sales_unit = SUM('판매데이터'[sales])` 같은 수식이 있을 경우에, `Sum()`을 실행하는 context가 총 합계가 될 수도 있지만, 상품 종류, 년/월 등의 context에 따라 소계로 계산될 수 있음을 의미합니다.
- Row context는 기타 언어의 iteration 개념이 도입되어 있다고 볼 수 있으며, 통상적으로 함수 뒤에 `X`가 붙습니다. (예: `SUMX()`)
  `SUMX()`를 예를 들면, 첫번째 인자로 iteration이 실행될 테이블을 지정하고, 두번째 인자로 계산식이 입력됩니다. 따라서 `Sales_unit = SUMX(판매데이터, 판매데이터[sales]*2)` 같은 수식을 지정할 수 있습니다.
- Filter context를 바꿀 수 있는 유일한 방법으로는 `CALCULATE(수식, 필터수식...)` 함수가 있습니다.

## 3. Running Total

- DAX의 time intelligence를 활용하면, 누적합계식을 구성할 수 있습니다.

- 누적합계식을 구성할 때에는 `CALCULATE()`함수를 사용하게 되는데, 이때 두번째 파라미터를 활용하여 원하는 context로 누적합계식을 구할 수 있습니다.

- 이때 `DATESYTD()`함수를 필터 컨택스트에 넣어서 계산하면, 손쉽게 년 단위의 누적합계식을 구성할 수 있습니다.

- 또 다른 방식은 필터 컨텍스트에  `FILTER(ALL())` 또는 `FILTER(ALLSELECTED())`함수로  구현할 수도 있습니다. 이 경우는 `ALL()` 또는 `ALLSELECTED()` 안에 누적합계식을 구성할 범위를 정하고, `MAX()` 함수로 기간을 설정하는 방식이 보편적이라고 할 수 있습니다.

  ```DAX
  누적합계 = CALCULATE(SUM(매출[sales]),
  				FILTER(ALL(날짜),
  						날짜[date] <= max(날짜[date])))
  ```

## 4. Rank

- 특정 변수의 순위를 계산할 때에는 `RANKX()` 함수를 사용할 수 있습니다.

- 함수명에 X가 붙어 있으므로 iteration을 활용하는 함수임을 가늠할 수 있으며, iteration context에 따라 ranking 산출 기준이 달라지게 됨 또한 가늠할 수 있습니다.

- 따라서 `RANKX()` 함수의 파라미터는 크게, 1) context, 2) 산정 기준 열, 3) 정렬 순서를 갖고 가게 됩니다.

  ```DAX
  판매순위 = RANKX(ALL(매출데이터),
  		  매출데이터[매출액], , DESC, )
  ```

## 5. TopN

- `RANKX()`와 유사한 syntax를 보유하고 있습니다.

  ```DAX
  순위 = TOPN(1, 매출데이터,
  		   매출데이터[매출액], DESC)
  ```

- 순서대로 첫번째 파라미터는 반환할 행의 수, 두번째 파라미터는 Iterator 테이블, 셉번째 파라미터는 순위를 산정할 수식, 그리고 그 다음은 정렬 순서를 나타내고 있습니다.

## 6.  Moving average

- 기간을 설정하여 이동평균을 구하는 함수도 지원을 하며 `AVERAGEX()`와 `DATESINPERIOD()`로 구현 가능합니다.

  ```DAX
  이동평균 = AVERAGEX(
  			DATESINPERIOD(날짜[날짜], LASTDATE(날짜[날짜]), -7, DAY),
  			매출액)
  ```

- 여기서 `ACERAGEX()` 함수는 테이블과 식을 인자로 받아 평균을 반환하는 함수입니다.

- `DATESINPERIOD()` 함수는 계산을 통해 테이블을 반환하는데, 이때 날짜와, 기초날짜, 뒤의 두 파라미터는 범위를 설정하도록 하게 됩니다.

## 7. Data segmentation (If/Switch)

- Data Segmentation은 쉽게 얘기해서 Numeric 데이터를 (혹은 String 데이터도 가능) `If()`/`Switch()`로 Categorical 데이터로 변환하는 과정을 의미하고는 합니다. 따라서 측정값으로 계산하기 보다는, 신규 열을 추가하는 방식을 가져가고는 합니다.

- `IF()`의 용법은 엑셀에서의 IF 구분과  크게 다르지 않으며, 중첩하여 사용할 수도 있습니다.

- 이와 달리 `Switch()` 함수는 중첩된 IF 구문을 대체할 때 용이하게 사용할 수 있으며, 아래 용법을 보면 이해하기 어렵지 않을 거라 생각합니다.

  ```DAX
  랭킹 = SWITCH(TRUE(),
  			[매출액]>1000, "최우수 아이템",
  			[매출액]>500, "일반 아이템",
  			[매출액]>300, "저조 아이템",
  			"관심대상")
  			
  SWITCH(<판별기준>, [<조건식1>, <판별1>], [<조건식2>, <판별2>], [그외])
  ```

- `IF()`와는 다르게, 하나의 판별 기준을 설정하기 때문에 (따라서 `TRUE()`를 가져가는 것이 일반적), 조건식을 설정하기도, 수정하기도 용이한 점을 장점으로 볼 수 있습니다.

## 8. DAX 테이블 함수

- **2. Evaluation concept**에서 한차례 언급 했었던 interation concept이 함수로 구현된 것을 DAX 테이블 함수라고하며, `SUMX()`처럼 함수 뒤에 `X`가 붙게 됩니다. 일반적인 함수가 **열**을 출력값으로 반환하는 것과는 다르게, **계산값**을 출력값으로 반환하기 때문에 연산 측면에서 강점이 있다고 할 수 있습니다.

- 테이블함수는 기본적으로 `테이블함수 = (<테이블>, <계산>)` 형태로 구현하게 되며, 첫번째 인자인 `<테이블>`을 1번행부터 n번행까지 iteration하며 계산한 결과값을 계산값으로 반환하게 됩니다. 파이썬으로 치면 `DataFrame().Apply()`함수와 유사하다고 볼 수 있을 것 같습니다.

- 단순한 리소스적 측면의 이점 외에도, 테이블 함수가 가진 강점은 [값] 기반의 `<계산>` 인수 입력에 있습니다. 일반 함수가 [열] 기반의 계산처리를 하는 것과는 다르게, 테이블 함수가 값 기반의 연산을 처리하다보니 **다른 측정값**으로 계산식을 만들어 새로운 측정값을 생성해 낼 수 있습니다.

- 때로는 실제 존재하는 테이블이 아닌, 가상의 테이블을 기준으로 iteration 하며 계산식을 만들고 싶은 경우가 생길 수도 있는데, 이때에는 `VALUES([열])`을 테이블 자리에 넣어서 해결할 수 있습니다. `VALUES()` 함수를 사용하면 중복값을 제외한 유일값으로 구성된 n*1 크기의 테이블을 반환하게 됩니다. 파이썬으로 치면 `DataFrame().[열].unique()`과 유사한 연산을 실행한다고 볼 수 있습니다.

  

https://www.youtube.com/watch?v=eMh3STI68LA
